import React, { useState, useMemo, useEffect, useRef } from 'react';
import { 
  Users, Moon, Sun, Plane, GraduationCap, AlertCircle, 
  Search, RefreshCw, Bot, CalendarDays, Edit3, X, Check, 
  Download, Plus, Trash2, UserPlus, RotateCcw,
  BarChart3, ChevronDown, Filter, ChevronLeft, ChevronRight,
  Settings, Upload, FileSpreadsheet,
  PieChart as PieChartIcon, Droplets, Sparkles, Zap,
  Copy, ClipboardPaste, Square, CheckSquare,
  GripVertical, Clock, FileJson 
} from 'lucide-react';
import { 
  PieChart, Pie, Cell, Tooltip as RechartsTooltip, ResponsiveContainer
} from 'recharts';
import { toPng } from 'html-to-image';
import { GoogleGenAI } from "@google/genai";

// ==========================================
// ğŸ”´ é…ç½®åŒºåŸŸ (å·²å¡«å…¥ä½ çš„ API Key)
// ==========================================
const GOOGLE_API_KEY = "AIzaSyDiCQXe3pjsMgGfEKdZvii23r6KE5nbt54";

// ==========================================
// 1. å¸¸é‡ä¸é…ç½®
// ==========================================

const STORAGE_KEY_EMPLOYEES = 'editorial_schedule_employees_v3';
const STORAGE_KEY_SCHEDULE = 'editorial_schedule_data_v3';
const STORAGE_KEY_THEME = 'editorial_schedule_theme';

const ShiftType = {
  DAY: 'DAY',
  NIGHT: 'NIGHT',
  LEAVE: 'LEAVE',
  TRIP: 'TRIP',
  TRAINING: 'TRAINING',
  OFF: 'OFF'
};

const DEFAULT_AREAS = [
  'äºŒåŒº1Fæ€»æˆè¯•éªŒ', 'äºŒåŒº1Fç”µæœºè¯•éªŒ', 'äºŒåŒº1Få››é©±è¯•éªŒ', 'äºŒåŒº3Fè¯•éªŒ', 
  'ä¸‰åŒº1Fç”µæ± è¯•éªŒ', 'ä¸‰åŒº2Fç”µæ± è¯•éªŒ', 'ä¸‰åŒº3Fç”µæ± è¯•éªŒ', 
  'é•¿æ²™å®éªŒå®¤', 'è®¾å¤‡ä¿éšœ', 'å‡ºå·®'
];

const DEFAULT_ROLES = ['å…¨éƒ¨', 'æŠ€å¸ˆ', 'åŠ³åŠ¡å·¥', 'å¤–åäººå‘˜', 'å®ä¹ ç”Ÿ'];

const TEST_BENCHES = [
  '2-105', '2-106', '2-107', '2-108', '2-109', '2-110', '2-111', '2-112',
  '2-115', '2-116', '2-117', '2-119', '2-121', '2-122', '2-124', '2-125',
  '2-126', '2-127', '2-129', '2-132', '2-134', '2-135',
  '3-136', '3-103', '3-104', '3-105', '3-106', '3-108', '3-109', '3-110',
  '3-111', '3-112', '3-202', '3-203', '3-204', '3-209', '3-301', '3-310',
  '3-312', '3-313', '3-315', 'BMSå®éªŒå®¤', 'åŠŸç‡ç”µå­å®éªŒå®¤', 'æ€§èƒ½è¯•éªŒå®¤', 'æ’æ”¾è¯•éªŒå®¤'
];

const MOCK_EMPLOYEES = [
  { id: '1', name: 'å¼ ä¸‰', role: 'æŠ€å¸ˆ', area: 'äºŒåŒº1Fæ€»æˆè¯•éªŒ' },
  { id: '2', name: 'æå››', role: 'åŠ³åŠ¡å·¥', area: 'äºŒåŒº3Fè¯•éªŒ' },
  { id: '3', name: 'ç‹äº”', role: 'æŠ€å¸ˆ', area: 'äºŒåŒº1Fç”µæœºè¯•éªŒ' },
  { id: '4', name: 'èµµå…­', role: 'å®ä¹ ç”Ÿ', area: 'ä¸‰åŒº1Fç”µæ± è¯•éªŒ' },
  { id: '5', name: 'é™ˆä¸ƒ', role: 'å¤–åäººå‘˜', area: 'ä¸‰åŒº2Fç”µæ± è¯•éªŒ' },
  { id: '6', name: 'åˆ˜å…«', role: 'åŠ³åŠ¡å·¥', area: 'äºŒåŒº3Fè¯•éªŒ' },
  { id: '7', name: 'å­™ä¹', role: 'å®ä¹ ç”Ÿ', area: 'ä¸‰åŒº3Fç”µæ± è¯•éªŒ' },
  { id: '8', name: 'å‘¨å', role: 'åŠ³åŠ¡å·¥', area: 'ä¸‰åŒº1Fç”µæ± è¯•éªŒ' },
  { id: '9', name: 'å´ä¸€', role: 'æŠ€å¸ˆ', area: 'äºŒåŒº1Få››é©±è¯•éªŒ' },
  { id: '10', name: 'éƒ‘äºŒ', role: 'å¤–åäººå‘˜', area: 'è®¾å¤‡ä¿éšœ' },
  { id: '11', name: 'å†¯ä¸‰', role: 'æŠ€å¸ˆ', area: 'é•¿æ²™å®éªŒå®¤' },
  { id: '12', name: 'è¤šå››', role: 'å®ä¹ ç”Ÿ', area: 'å‡ºå·®' },
];

const INITIAL_SCHEDULE = [];

const SHIFT_LABELS = {
  [ShiftType.DAY]: 'ç™½ç­',
  [ShiftType.NIGHT]: 'å¤œç­',
  [ShiftType.LEAVE]: 'è¯·å‡',
  [ShiftType.TRIP]: 'å‡ºå·®',
  [ShiftType.TRAINING]: 'åŸ¹è®­',
  [ShiftType.OFF]: 'ä¼‘æ¯'
};

const SHIFT_COLORS = {
  [ShiftType.DAY]: 'bg-[#81C784] text-white border-transparent hover:brightness-110 shadow-sm',
  [ShiftType.NIGHT]: 'bg-[#9C27B0] text-white border-transparent hover:brightness-110 shadow-sm',
  [ShiftType.LEAVE]: 'bg-[#FF8A80] text-white border-transparent hover:brightness-110 shadow-sm',
  [ShiftType.TRIP]: 'bg-[#FFB74D] text-white border-transparent hover:brightness-110 shadow-sm',
  [ShiftType.TRAINING]: 'bg-[#4DD0E1] text-white border-transparent hover:brightness-110 shadow-sm',
  [ShiftType.OFF]: 'bg-[#E0E0E0] text-slate-500 border-transparent hover:brightness-110'
};

const STATS_COLORS = {
  [ShiftType.DAY]: '#4CAF50',
  [ShiftType.NIGHT]: '#9C27B0',
  [ShiftType.TRIP]: '#FFC107',
  [ShiftType.TRAINING]: '#9C27B0',
  [ShiftType.LEAVE]: '#F44336',
  [ShiftType.OFF]: '#E0E0E0'
};

const analyzeSchedule = async (schedule, employees) => {
  try {
    const apiKey = GOOGLE_API_KEY;
    if (!apiKey) {
      return JSON.stringify({ 
        summary: "æœªé…ç½® API Keyã€‚è¯·åœ¨ä»£ç é¡¶éƒ¨é…ç½®ã€‚", 
        issues: [], 
        recommendations: [] 
      });
    }
    const ai = new GoogleGenAI({ apiKey });
    const summary = schedule.map(s => {
      const emp = employees.find(e => e.id === s.employeeId);
      const benches = s.benchIds && s.benchIds.length > 0 ? `[å°æ¶: ${s.benchIds.join(', ')}]` : '';
      return `${s.date}: ${emp?.name} (${emp?.area}) is on ${s.shift} ${benches}`;
    }).join('\n');
    
    // ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šå¼ºåˆ¶è¦æ±‚ä¸­æ–‡å›å¤
    const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ’ç­ç®¡ç†åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ’ç­æ•°æ®ç”Ÿæˆä¸€ä»½ JSON æ ¼å¼çš„åˆ†ææŠ¥å‘Šã€‚
    
    æ•°æ®å¦‚ä¸‹ï¼š
    ${summary}

    è¦æ±‚ï¼š
    1. å¿…é¡»è¿”å›çº¯ JSON æ ¼å¼ã€‚
    2. JSON åŒ…å«ä¸‰ä¸ªå­—æ®µï¼š
       - summary: (å­—ç¬¦ä¸²) æ’ç­æƒ…å†µçš„æ€»ä½“æ¦‚è¿°ã€‚
       - issues: (å­—ç¬¦ä¸²æ•°ç»„) å‘ç°çš„æ½œåœ¨é—®é¢˜æˆ–é£é™©ï¼ˆå¦‚è¿ç»­å¤œç­ã€å‘¨æœ«åŠ ç­è¿‡å¤šç­‰ï¼‰ã€‚
       - recommendations: (å­—ç¬¦ä¸²æ•°ç»„) é’ˆå¯¹é—®é¢˜çš„å…·ä½“ä¼˜åŒ–å»ºè®®ã€‚
    3. ğŸ”´ é‡è¦ï¼šæ‰€æœ‰åˆ†æå†…å®¹ï¼ˆsummary, issues, recommendationsï¼‰å¿…é¡»å®Œå…¨ä½¿ç”¨ä¸­æ–‡è¿›è¡Œå›å¤ã€‚`;

    const response = await ai.models.generateContent({
      model: 'gemini-2.0-flash',
      contents: prompt,
      config: { responseMimeType: "application/json" }
    });
    return response.text || "{}";
  } catch (error) {
    console.error(error);
    return JSON.stringify({ summary: "åˆ†ææœåŠ¡è¿æ¥å¤±è´¥", issues: ["æ— æ³•è¿æ¥åˆ° AI æ¨¡å‹"], recommendations: ["è¯·æ£€æŸ¥ç½‘ç»œæˆ– API Key é…ç½®"] });
  }
};

const statsCardColorMap = {
  blue: 'border-blue-200/50 shadow-[0_4px_6px_-1px_rgba(59,130,246,0.1)]',
  cyan: 'border-cyan-200/50 shadow-[0_4px_6px_-1px_rgba(6,182,212,0.1)]',
  purple: 'border-purple-200/50 shadow-[0_4px_6px_-1px_rgba(168,85,247,0.1)]',
  amber: 'border-amber-200/50 shadow-[0_4px_6px_-1px_rgba(245,158,11,0.1)]',
  emerald: 'border-emerald-200/50 shadow-[0_4px_6px_-1px_rgba(16,185,129,0.1)]',
  red: 'border-red-200/50 shadow-[0_4px_6px_-1px_rgba(239,68,68,0.1)]',
  gray: 'border-gray-200/50 bg-gray-50/50',
};

const statsCardTextColorMap = {
  blue: 'text-blue-600 dark:text-blue-400',
  cyan: 'text-cyan-600 dark:text-cyan-400',
  purple: 'text-purple-600 dark:text-purple-400',
  amber: 'text-amber-600 dark:text-amber-400',
  emerald: 'text-emerald-600 dark:text-emerald-400',
  red: 'text-red-600 dark:text-red-400',
  gray: 'text-gray-400',
};

const StatsCard = ({ title, value, icon, color, draggable, onDragStart, onDragOver, onDrop }) => {
  const isPlaceholder = color === 'gray';
  return (
    <div 
      draggable={draggable && !isPlaceholder}
      onDragStart={onDragStart}
      onDragOver={onDragOver}
      onDrop={onDrop}
      className={`relative overflow-hidden rounded-xl border bg-skin-card p-4 flex items-center gap-4 transition-all ${!isPlaceholder ? 'hover:scale-[1.02] hover:shadow-lg' : 'opacity-60 border-dashed'} ${draggable ? 'cursor-move active:cursor-grabbing' : ''} ${statsCardColorMap[color] || statsCardColorMap.blue}`}
    >
      <div className="absolute top-0 right-0 p-1 opacity-10 transform translate-x-2 -translate-y-2 text-skin-base">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
          <path d="M0 0H40V40" stroke="currentColor" strokeWidth="4"/>
        </svg>
      </div>
      <div className={`p-3 rounded-full ${isPlaceholder ? 'bg-gray-100' : 'bg-skin-fill'} ring-1 ring-skin-border`}>
        {icon}
      </div>
      <div>
        <div className={`text-3xl font-bold tracking-tighter font-sans ${statsCardTextColorMap[color] || statsCardTextColorMap.blue}`}>{value}</div>
        <div className="text-xs uppercase tracking-widest opacity-70 font-semibold text-skin-muted truncate max-w-[100px]" title={title}>{title}</div>
      </div>
    </div>
  );
};

// ==========================================
// ä¸»ç»„ä»¶ (App)
// ==========================================

const App = () => {
  const [currentTheme, setCurrentTheme] = useState(() => localStorage.getItem(STORAGE_KEY_THEME) || 'light');
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', currentTheme);
    localStorage.setItem(STORAGE_KEY_THEME, currentTheme);
  }, [currentTheme]);
  
  const [currentDate, setCurrentDate] = useState(new Date());
  
  const safeJsonParse = (key, fallback) => {
    try {
      const saved = localStorage.getItem(key);
      if (!saved) return fallback;
      const parsed = JSON.parse(saved);
      return Array.isArray(parsed) ? parsed : fallback;
    } catch (e) {
      console.warn(`Load failed for ${key}, using default.`);
      return fallback;
    }
  };

  const [configAreas, setConfigAreas] = useState(() => safeJsonParse('sys_config_areas', DEFAULT_AREAS));
  const [configRoles, setConfigRoles] = useState(() => safeJsonParse('sys_config_roles', DEFAULT_ROLES.filter(r => r !== 'å…¨éƒ¨')));
  const [configBenches, setConfigBenches] = useState(() => safeJsonParse('sys_config_benches', TEST_BENCHES));

  const [isConfigModalOpen, setIsConfigModalOpen] = useState(false);
  const [newAreaInput, setNewAreaInput] = useState('');
  const [newRoleInput, setNewRoleInput] = useState('');
  const [newBenchInput, setNewBenchInput] = useState('');

  const [employees, setEmployees] = useState(() => {
    try {
      const saved = localStorage.getItem(STORAGE_KEY_EMPLOYEES);
      return saved ? JSON.parse(saved) : MOCK_EMPLOYEES;
    } catch { return MOCK_EMPLOYEES; }
  });
  const [schedule, setSchedule] = useState(() => {
    try {
      const saved = localStorage.getItem(STORAGE_KEY_SCHEDULE);
      return saved ? JSON.parse(saved) : INITIAL_SCHEDULE;
    } catch { return INITIAL_SCHEDULE; }
  });
  
  const [filterName, setFilterName] = useState('');
  const [filterAreas, setFilterAreas] = useState([]);
  const [isAreaFilterOpen, setIsAreaFilterOpen] = useState(false);
  const [filterShift, setFilterShift] = useState('å…¨éƒ¨');

  const [aiAnalysis, setAiAnalysis] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const dashboardRef = useRef(null);
  const [isExporting, setIsExporting] = useState(false);
  
  const fileInputRef = useRef(null);

  const [isStatsModalOpen, setIsStatsModalOpen] = useState(false);
  const [statsDimension, setStatsDimension] = useState('month');
  const [statsYear, setStatsYear] = useState(new Date().getFullYear());
  const [statsMonth, setStatsMonth] = useState(new Date().getMonth() + 1);
  const [statsQuarter, setStatsQuarter] = useState(Math.floor((new Date().getMonth() + 3) / 3));
  const [statsSearchName, setStatsSearchName] = useState('');
  const [statsFilterArea, setStatsFilterArea] = useState('å…¨éƒ¨');
  const [statsSortConfig, setStatsSortConfig] = useState({ key: 'total', direction: 'desc' });
  const [statsSelectedChartSegment, setStatsSelectedChartSegment] = useState(null);
  const [selectedPersonStats, setSelectedPersonStats] = useState(null);

  const [isImportModalOpen, setIsImportModalOpen] = useState(false);
  const [importText, setImportText] = useState('');

  const [isAutoModalOpen, setIsAutoModalOpen] = useState(false);
  const [autoType, setAutoType] = useState('night');
  const [autoCycle, setAutoCycle] = useState('2'); 
  const [autoStartDate, setAutoStartDate] = useState(new Date().toISOString().split('T')[0]);
  const [autoTargetArea, setAutoTargetArea] = useState('æ‰€æœ‰åŒºåŸŸ');

  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [editingCell, setEditingCell] = useState(null);
  const [tempShift, setTempShift] = useState(ShiftType.DAY);
  const [tempBenchIds, setTempBenchIds] = useState([]);
  const [customBench, setCustomBench] = useState('');
  const [isAddingBench, setIsAddingBench] = useState(false);

  const [benchClipboard, setBenchClipboard] = useState(null);

  const [isEmpModalOpen, setIsEmpModalOpen] = useState(false);
  const [editingEmp, setEditingEmp] = useState(null); 
  const [tempEmpData, setTempEmpData] = useState({});

  const [draggedRowId, setDraggedRowId] = useState(null);

  const handleRowDragStart = (e, id) => {
    setDraggedRowId(id);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleRowDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  };

  const handleRowDrop = (e, targetId) => {
    e.preventDefault();
    if (!draggedRowId || draggedRowId === targetId) return;
    const newEmployees = [...employees];
    const draggedIndex = newEmployees.findIndex(emp => emp.id === draggedRowId);
    const targetIndex = newEmployees.findIndex(emp => emp.id === targetId);
    if (draggedIndex === -1 || targetIndex === -1) return;
    const [movedItem] = newEmployees.splice(draggedIndex, 1);
    newEmployees.splice(targetIndex, 0, movedItem);
    setEmployees(newEmployees);
    setDraggedRowId(null);
  };

  useEffect(() => { localStorage.setItem(STORAGE_KEY_EMPLOYEES, JSON.stringify(employees)); }, [employees]);
  useEffect(() => { localStorage.setItem(STORAGE_KEY_SCHEDULE, JSON.stringify(schedule)); }, [schedule]);
  
  useEffect(() => { if(Array.isArray(configAreas)) localStorage.setItem('sys_config_areas', JSON.stringify(configAreas)); }, [configAreas]);
  useEffect(() => { if(Array.isArray(configRoles)) localStorage.setItem('sys_config_roles', JSON.stringify(configRoles)); }, [configRoles]);
  useEffect(() => { if(Array.isArray(configBenches)) localStorage.setItem('sys_config_benches', JSON.stringify(configBenches)); }, [configBenches]);

  const dates = useMemo(() => {
    const curr = new Date(currentDate);
    const day = curr.getDay();
    const diff = curr.getDate() - day + (day === 0 ? -6 : 1); 
    const monday = new Date(curr);
    monday.setDate(diff);
    const res = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      res.push(d.toISOString().split('T')[0]);
    }
    return res;
  }, [currentDate]);

  const filteredEmployees = useMemo(() => {
    if (!Array.isArray(employees)) return [];
    return employees.filter(emp => {
      const matchName = emp.name.toLowerCase().includes(filterName.toLowerCase());
      const matchArea = filterAreas.length === 0 || filterAreas.includes(emp.area);
      let matchShift = true;
      if (filterShift !== 'å…¨éƒ¨') {
        matchShift = dates.some(date => {
          const entry = schedule.find(s => s.employeeId === emp.id && s.date === date);
          const currentShift = entry ? entry.shift : ShiftType.DAY;
          return currentShift === filterShift;
        });
      }
      return matchName && matchArea && matchShift;
    });
  }, [employees, filterName, filterAreas, filterShift, schedule, dates]);

  const stats = useMemo(() => {
    const visibleSchedule = schedule.filter(s => dates.includes(s.date));
    const getUniquePeopleCount = (shiftType) => {
      const uniqueIds = new Set(visibleSchedule.filter(s => s.shift === shiftType).map(s => s.employeeId));
      return uniqueIds.size;
    };
    return {
      totalScheduled: employees.length,
      currentOnDuty: getUniquePeopleCount(ShiftType.DAY),
      currentNightShift: getUniquePeopleCount(ShiftType.NIGHT),
      training: visibleSchedule.filter(s => s.shift === ShiftType.TRAINING).length,
      onLeave: getUniquePeopleCount(ShiftType.LEAVE),
      businessTrip: getUniquePeopleCount(ShiftType.TRIP),
      rest: visibleSchedule.filter(s => s.shift === ShiftType.OFF).length,
    };
  }, [schedule, employees, dates]);

  const areaStats = useMemo(() => {
    const absentEmployees = new Set(
      schedule
        .filter(s => dates.includes(s.date) && (
          s.shift === ShiftType.TRIP || 
          s.shift === ShiftType.LEAVE ||
          s.shift === ShiftType.TRAINING
        ))
        .map(s => s.employeeId)
    );

    const rawStats = configAreas.map(area => ({
      area,
      count: employees.filter(e => e.area === area && !absentEmployees.has(e.id)).length,
      isPlaceholder: false
    }));

    const slots = rawStats.slice(0, 8); 
    while(slots.length < 8) {
      slots.push({ area: 'ç©ºé—²å¡ä½', count: '-', isPlaceholder: true });
    }
    return slots;
  }, [configAreas, employees, schedule, dates]);

  const areaColors = ['blue', 'cyan', 'purple', 'emerald', 'amber', 'red'];

  const handleDragStart = (e, index) => {
    e.dataTransfer.setData('text/plain', index);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleDragOver = (e) => {
    e.preventDefault(); 
  };

  const handleDrop = (e, dropIndex) => {
    e.preventDefault();
    const dragIndex = Number(e.dataTransfer.getData('text/plain'));
    if (dragIndex === dropIndex) return;
    const newAreas = [...configAreas];
    if (dragIndex >= newAreas.length || dropIndex >= newAreas.length) return;
    const [removed] = newAreas.splice(dragIndex, 1);
    newAreas.splice(dropIndex, 0, removed);
    setConfigAreas(newAreas);
  };

  const toggleAreaFilter = (area) => {
    setFilterAreas(prev => {
      if (prev.includes(area)) {
        return prev.filter(a => a !== area);
      } else {
        return [...prev, area];
      }
    });
  };

  const { statisticsData, statsSummary } = useMemo(() => {
    if (!isStatsModalOpen) return { statisticsData: [], statsSummary: null };
    const relevantEntries = schedule.filter(entry => {
      const [y, m] = entry.date.split('-').map(Number);
      if (y !== statsYear) return false;
      if (statsDimension === 'month') return m === statsMonth;
      if (statsDimension === 'quarter') return Math.ceil(m / 3) === statsQuarter;
      return true;
    });
    let targetEmployees = employees.filter(e => {
        const matchName = e.name.includes(statsSearchName);
        const matchArea = statsFilterArea === 'å…¨éƒ¨' || e.area === statsFilterArea;
        return matchName && matchArea;
    });
    let data = targetEmployees.map(emp => {
      const empEntries = relevantEntries.filter(e => e.employeeId === emp.id);
      const dayShift = empEntries.filter(e => e.shift === ShiftType.DAY).length;
      const nightShift = empEntries.filter(e => e.shift === ShiftType.NIGHT).length;
      const trip = empEntries.filter(e => e.shift === ShiftType.TRIP).length;
      const fieldWork = empEntries.filter(e => e.shift === ShiftType.TRAINING).length;
      const leave = empEntries.filter(e => e.shift === ShiftType.LEAVE).length;
      const total = empEntries.filter(e => e.shift !== ShiftType.OFF).length;
      const weekendOvertime = empEntries.filter(e => {
         const d = new Date(e.date);
         const day = d.getDay();
         return (day === 0 || day === 6) && (e.shift === ShiftType.DAY || e.shift === ShiftType.NIGHT);
      }).length;
      return { id: emp.id, name: emp.name, area: emp.area, dayShift, nightShift, trip, fieldWork, leave, total, weekendOvertime, entries: empEntries };
    });
    if (statsSelectedChartSegment) {
        data = data.filter(item => {
            if (statsSelectedChartSegment === ShiftType.DAY) return item.dayShift > 0;
            if (statsSelectedChartSegment === ShiftType.NIGHT) return item.nightShift > 0;
            if (statsSelectedChartSegment === ShiftType.TRIP) return item.trip > 0;
            if (statsSelectedChartSegment === ShiftType.TRAINING) return item.fieldWork > 0;
            if (statsSelectedChartSegment === ShiftType.LEAVE) return item.leave > 0;
            return true;
        });
    }
    data.sort((a, b) => {
      const valA = a[statsSortConfig.key]; const valB = b[statsSortConfig.key];
      if (typeof valA === 'number' && typeof valB === 'number') return statsSortConfig.direction === 'asc' ? valA - valB : valB - valA;
      return 0;
    });
    const totalManDays = data.reduce((acc, curr) => acc + curr.total, 0);
    const totalDay = data.reduce((acc, curr) => acc + curr.dayShift, 0);
    const totalNight = data.reduce((acc, curr) => acc + curr.nightShift, 0);
    const totalTrip = data.reduce((acc, curr) => acc + curr.trip, 0);
    const totalField = data.reduce((acc, curr) => acc + curr.fieldWork, 0);
    const totalLeave = data.reduce((acc, curr) => acc + curr.leave, 0);
    const summary = {
        totalManDays,
        dayRate: totalManDays ? Math.round((totalDay / totalManDays) * 100) : 0,
        nightRate: totalManDays ? Math.round((totalNight / totalManDays) * 100) : 0,
        leaveRate: totalManDays ? Math.round((totalLeave / totalManDays) * 100) : 0,
        distribution: [
            { name: 'ç™½ç­', value: totalDay, fill: STATS_COLORS[ShiftType.DAY], type: ShiftType.DAY },
            { name: 'å¤œç­', value: totalNight, fill: STATS_COLORS[ShiftType.NIGHT], type: ShiftType.NIGHT },
            { name: 'å‡ºå‹¤', value: totalTrip, fill: STATS_COLORS[ShiftType.TRIP], type: ShiftType.TRIP },
            { name: 'å¤–å‹¤', value: totalField, fill: STATS_COLORS[ShiftType.TRAINING], type: ShiftType.TRAINING },
            { name: 'è¯·å‡', value: totalLeave, fill: STATS_COLORS[ShiftType.LEAVE], type: ShiftType.LEAVE },
        ].filter(d => d.value > 0)
    };
    return { statisticsData: data, statsSummary: summary };
  }, [isStatsModalOpen, schedule, employees, statsDimension, statsYear, statsMonth, statsQuarter, statsSearchName, statsFilterArea, statsSortConfig, statsSelectedChartSegment, configAreas]);

  const handleStatsSort = (key) => {
    setStatsSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'desc' ? 'asc' : 'desc' }));
  };
  const handleExportCSV = () => {
    const headers = ['å§“å', 'åŒºåŸŸ', 'ç™½ç­', 'å¤œç­', 'å‡ºå‹¤', 'å¤–å‹¤', 'è¯·å‡', 'å‘¨æœ«åŠ ç­', 'æ€»è®¡'];
    const rows = statisticsData.map(d => [d.name, d.area, d.dayShift, d.nightShift, d.trip, d.fieldWork, d.leave, d.weekendOvertime, d.total].join(','));
    const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(',') + "\n" + rows.join('\n');
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `æ’ç­ç»Ÿè®¡.csv`);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
  };
  const displayBenches = useMemo(() => {
    const extras = tempBenchIds.filter(id => !configBenches.includes(id));
    return [...configBenches, ...extras];
  }, [configBenches, tempBenchIds]);

  const handleWeekChange = (offset) => {
    setCurrentDate(prev => { const d = new Date(prev); d.setDate(d.getDate() + offset * 7); return d; });
  };
  const handleAnalyze = async () => {
    setIsAnalyzing(true);
    const visibleSchedule = schedule.filter(s => dates.includes(s.date));
    const resultJson = await analyzeSchedule(visibleSchedule, employees);
    try { setAiAnalysis(JSON.parse(resultJson)); } catch (e) { console.error(e); alert("AIåˆ†æå‡ºé”™"); } finally { setIsAnalyzing(false); }
  };
  
  // ğŸŸ¢ ä½¿ç”¨ html-to-image çš„å…¨é¡µæˆªå›¾åŠŸèƒ½
  const handleExportImage = async () => {
    if (dashboardRef.current === null) return;
    setIsExporting(true);
    try {
      // å¢åŠ å»¶æ—¶ç¡®ä¿æ¸²æŸ“å®Œæˆ
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // è§£å†³ Safari/Chrome æŸäº›æƒ…å†µä¸‹çš„æ¸²æŸ“é—®é¢˜
      const dataUrl = await toPng(dashboardRef.current, { 
        cacheBust: true, 
        backgroundColor: currentTheme === 'dark' ? '#0f172a' : '#f8fafc', 
        pixelRatio: 2, // æé«˜æ¸…æ™°åº¦
        filter: (node) => {
            // è¿‡æ»¤æ‰ä¸éœ€è¦æˆªå›¾çš„å…ƒç´ ï¼ˆå¦‚æœæœ‰ï¼‰
            return node.tagName !== 'i'; 
        }
      });
      
      const link = document.createElement('a'); 
      link.download = `æ’ç­è¡¨-${dates[0]}.png`; 
      link.href = dataUrl; 
      link.click();
    } catch (err) { 
      console.error(err); 
      alert('å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally { 
      setIsExporting(false); 
    }
  };

  const handleExportJSON = () => {
    const dataToExport = {
      employees,
      schedule,
      configAreas,
      configRoles,
      configBenches,
      exportDate: new Date().toISOString()
    };
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", `æ’ç­ç³»ç»Ÿå¤‡ä»½-${new Date().toISOString().split('T')[0]}.json`);
    document.body.appendChild(downloadAnchorNode); 
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
  };

  const handleImportJSON = (event) => {
    const fileObj = event.target.files && event.target.files[0];
    if (!fileObj) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const json = JSON.parse(e.target.result);
        if (!json.employees || !json.schedule) {
          alert("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘å…³é”®æ•°æ®(employees/schedule)");
          return;
        }

        if (window.confirm("å¯¼å…¥å°†è¦†ç›–å½“å‰æ‰€æœ‰æ’ç­ã€äººå‘˜åŠé…ç½®æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ")) {
          if (json.employees) setEmployees(json.employees);
          if (json.schedule) setSchedule(json.schedule);
          if (json.configAreas) setConfigAreas(json.configAreas);
          if (json.configRoles) setConfigRoles(json.configRoles);
          if (json.configBenches) setConfigBenches(json.configBenches);

          localStorage.setItem(STORAGE_KEY_EMPLOYEES, JSON.stringify(json.employees));
          localStorage.setItem(STORAGE_KEY_SCHEDULE, JSON.stringify(json.schedule));
          if(json.configAreas) localStorage.setItem('sys_config_areas', JSON.stringify(json.configAreas));
          if(json.configRoles) localStorage.setItem('sys_config_roles', JSON.stringify(json.configRoles));
          if(json.configBenches) localStorage.setItem('sys_config_benches', JSON.stringify(json.configBenches));

          alert("æ•°æ®å¯¼å…¥æˆåŠŸï¼");
        }
      } catch (error) {
        console.error(error);
        alert("JSON è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹");
      }
    };
    reader.readAsText(fileObj);
    event.target.value = null; 
  };

  const handleResetData = () => {
    if(window.confirm('ç¡®å®šé‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
      localStorage.removeItem(STORAGE_KEY_EMPLOYEES); localStorage.removeItem(STORAGE_KEY_SCHEDULE);
      localStorage.removeItem('sys_config_areas'); localStorage.removeItem('sys_config_roles'); localStorage.removeItem('sys_config_benches');
      window.location.reload();
    }
  };

  // ğŸŸ¢ æ–°å¢ï¼šå¤åˆ¶æœ¬å‘¨æ’ç­åˆ°ä¸‹ä¸€å‘¨çš„åŠŸèƒ½
  const handleCopyWeekToNext = () => {
    if (!window.confirm("ç¡®å®šè¦æŠŠæœ¬å‘¨çš„æ’ç­ä¿¡æ¯å®Œå…¨å¤åˆ¶åˆ°ä¸‹ä¸€å‘¨å—ï¼Ÿ\næ³¨æ„ï¼šä¸‹ä¸€å‘¨åŸæœ‰çš„æ’ç­å°†è¢«è¦†ç›–ã€‚")) {
      return;
    }

    // 1. è·å–æœ¬å‘¨æ‰€æœ‰æ—¥æœŸçš„å­—ç¬¦ä¸²
    // 2. åˆ›å»ºä¸€ä¸ªæ˜ å°„ï¼Œå°†æœ¬å‘¨çš„æ—¥æœŸå¯¹åº”åˆ°ä¸‹å‘¨çš„æ—¥æœŸ
    const dateMap = {}; // oldDate -> newDate
    dates.forEach(dateStr => {
      const d = new Date(dateStr);
      d.setDate(d.getDate() + 7);
      const newDateStr = d.toISOString().split('T')[0];
      dateMap[dateStr] = newDateStr;
    });

    const nextWeekDates = Object.values(dateMap);

    setSchedule(prev => {
      // 3. å…ˆç§»é™¤ä¸‹ä¸€å‘¨å·²æœ‰çš„æ’ç­æ•°æ®ï¼Œé¿å…å†²çªæˆ–é‡å¤
      const filteredSchedule = prev.filter(s => !nextWeekDates.includes(s.date));

      // 4. ç­›é€‰å‡ºæœ¬å‘¨çš„æ’ç­æ•°æ®
      const currentWeekEntries = prev.filter(s => dates.includes(s.date));

      // 5. ç”Ÿæˆæ–°çš„æ’ç­æ•°æ®ï¼ˆæ—¥æœŸæ¨å7å¤©ï¼Œä¿æŒå°æ¶ã€åŒºåŸŸã€ç­æ¬¡ä¸å˜ï¼‰
      const newEntries = currentWeekEntries.map(entry => ({
        ...entry,
        date: dateMap[entry.date], // ä½¿ç”¨æ˜ å°„åçš„æ–°æ—¥æœŸ
        // employeeId, shift, benchIds, location ç­‰ä¿¡æ¯é€šè¿‡ ...entry è‡ªåŠ¨å¤åˆ¶
      }));

      return [...filteredSchedule, ...newEntries];
    });

    alert("æœ¬å‘¨æ’ç­å·²æˆåŠŸå¤åˆ¶åˆ°ä¸‹ä¸€å‘¨ï¼");
  };

  const handleAddConfigItem = (type, value) => {
    const val = value.trim(); if (!val) return;
    if (type === 'area' && !configAreas.includes(val)) { setConfigAreas(p => [...p, val]); setNewAreaInput(''); }
    else if (type === 'role' && !configRoles.includes(val)) { setConfigRoles(p => [...p, val]); setNewRoleInput(''); }
    else if (type === 'bench' && !configBenches.includes(val)) { setConfigBenches(p => [...p, val]); setNewBenchInput(''); }
  };
  const handleDeleteConfigItem = (type, value) => {
      if (type === 'area') setConfigAreas(p => p.filter(i => i !== value));
      else if (type === 'role') setConfigRoles(p => p.filter(i => i !== value));
      else if (type === 'bench') setConfigBenches(p => p.filter(i => i !== value));
  };
  const getShiftFor = (empId, date) => schedule.find(s => s.employeeId === empId && s.date === date);
  
  const checkShiftConstraints = (empId, targetDateStr, newShift) => {
    if (newShift !== ShiftType.NIGHT && newShift !== ShiftType.DAY) return null;
    const emp = employees.find(e => e.id === empId);
    if (!emp) return null;
    const targetDate = new Date(targetDateStr);
    if (newShift === ShiftType.NIGHT) {
        const prevWeekDate = new Date(targetDate); prevWeekDate.setDate(targetDate.getDate() - 7);
        const prev2WeekDate = new Date(targetDate); prev2WeekDate.setDate(targetDate.getDate() - 14);
        const hasPrevNight = schedule.some(s => s.employeeId === empId && s.shift === ShiftType.NIGHT && s.date === prevWeekDate.toISOString().split('T')[0]);
        const hasPrev2Night = schedule.some(s => s.employeeId === empId && s.shift === ShiftType.NIGHT && s.date === prev2WeekDate.toISOString().split('T')[0]);
        if (hasPrevNight && hasPrev2Night) return `ã€${emp.name}ã€‘å·²è¿ç»­ä¸¤å‘¨æ’äº†å¤œç­ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`;
    }
    const dayOfWeek = targetDate.getDay();
    if (dayOfWeek === 0 || dayOfWeek === 6) {
        const prevWeekDate = new Date(targetDate); prevWeekDate.setDate(targetDate.getDate() - 7);
        const hasPrevWeekendShift = schedule.some(s => s.employeeId === empId && (s.shift === ShiftType.DAY || s.shift === ShiftType.NIGHT) && s.date === prevWeekDate.toISOString().split('T')[0]);
        if (hasPrevWeekendShift) return `ã€${emp.name}ã€‘ä¸Šä¸ªå‘¨æœ«å·²åŠ ç­ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`;
    }
    return null;
  };

  const handleCellClick = (empId, date, currentShift, currentBenchIds) => {
    setEditingCell({ empId, date, currentShift }); setTempShift(currentShift); setTempBenchIds(currentBenchIds || []);
    setCustomBench(''); setIsAddingBench(false); setIsEditModalOpen(true);
  };
  const toggleBenchSelection = (bench) => {
    setTempBenchIds(prev => prev.includes(bench) ? prev.filter(b => b !== bench) : [...prev, bench]);
  };
  
  const handleCopyBenches = (e, benchIds) => {
    e.stopPropagation(); 
    if (benchIds && benchIds.length > 0) {
      setBenchClipboard(benchIds);
    }
  };

  const handlePasteBenches = (e, empId, date) => {
    e.stopPropagation();
    if (!benchClipboard) return;
    setSchedule(prev => {
      const newSchedule = [...prev];
      const index = newSchedule.findIndex(s => s.employeeId === empId && s.date === date);
      let newShift = ShiftType.DAY;
      let location = employees.find(e => e.id === empId)?.area;
      if (index >= 0) {
        newSchedule[index] = { ...newSchedule[index], benchIds: benchClipboard };
      } else {
        newSchedule.push({ employeeId: empId, date: date, shift: newShift, benchIds: benchClipboard, location: location });
      }
      return newSchedule;
    });
  };

  const handleSaveShift = () => {
    if (!editingCell) return;
    const warning = checkShiftConstraints(editingCell.empId, editingCell.date, tempShift);
    if (warning) { if (!window.confirm(warning)) return; }
    setSchedule(prev => {
      const newSchedule = [...prev];
      const index = newSchedule.findIndex(s => s.employeeId === editingCell.empId && s.date === editingCell.date);
      const finalBenchIds = (tempShift === ShiftType.DAY || tempShift === ShiftType.NIGHT) ? tempBenchIds : undefined;
      const newEntry = { employeeId: editingCell.empId, date: editingCell.date, shift: tempShift, benchIds: finalBenchIds, location: employees.find(e => e.id === editingCell.empId)?.area };
      if (index >= 0) newSchedule[index] = newEntry; else newSchedule.push(newEntry);
      return newSchedule;
    });
    setIsEditModalOpen(false); setEditingCell(null);
  };
  
  const handleAddEmployee = () => { setEditingEmp(null); setTempEmpData({ name: '', role: configRoles[0]||'æŠ€å¸ˆ', area: configAreas[0]||'äºŒåŒº1Fæ€»æˆè¯•éªŒ' }); setIsEmpModalOpen(true); };
  
  const handleBulkImport = () => {
    if (!importText.trim()) return;
    const names = importText.split(/[\n,ï¼Œ\s]+/).filter(n => n.trim().length > 0);
    if (names.length === 0) { alert("è¯·è¾“å…¥æœ‰æ•ˆå§“å"); return; }
    const defaultArea = configAreas[0] || 'äºŒåŒº1Fæ€»æˆè¯•éªŒ'; 
    const defaultRole = configRoles[0] || 'æŠ€å¸ˆ';
    const newEmployees = names.map(name => ({ 
      id: Math.random().toString(36).substr(2, 9), 
      name: name.trim(), 
      role: defaultRole, 
      area: defaultArea 
    }));
    setEmployees(prev => [...prev, ...newEmployees]); 
    setImportText(''); 
    setIsImportModalOpen(false); 
    alert(`æˆåŠŸå¯¼å…¥ ${newEmployees.length} äºº`);
  };

  const handleEditEmployee = (emp) => { setEditingEmp(emp); setTempEmpData({ ...emp }); setIsEmpModalOpen(true); };
  const handleSaveEmployee = () => {
    if (!tempEmpData.name) { alert("è¯·è¾“å…¥å§“å"); return; }
    const updatedName = tempEmpData.name.trim();
    let updatedArea = tempEmpData.area || configAreas[0] || 'äºŒåŒº1Fæ€»æˆè¯•éªŒ';
    const updatedRole = tempEmpData.role || configRoles[0] || 'æŠ€å¸ˆ';
    if (editingEmp) {
      setEmployees(prev => prev.map(e => e.id === editingEmp.id ? { ...e, name: updatedName, area: updatedArea, role: updatedRole } : e));
      setSchedule(prev => prev.map(s => s.employeeId === editingEmp.id ? { ...s, location: updatedArea } : s));
    } else {
      setEmployees(prev => [...prev, { id: Math.random().toString(36).substr(2, 9), name: updatedName, role: updatedRole, area: updatedArea }]);
    }
    setIsEmpModalOpen(false);
  };
  const executeDeleteEmployee = (targetId, targetName, e) => {
    if (e) { e.stopPropagation(); e.preventDefault(); }
    setTimeout(() => {
        if (window.confirm(`ç¡®å®šè¦å½»åº•åˆ é™¤äººå‘˜ "${targetName}" å—ï¼Ÿ`)) {
            setEmployees(prev => prev.filter(e => e.id !== targetId));
            setSchedule(prev => prev.filter(s => s.employeeId !== targetId));
            if (editingEmp?.id === targetId) { setIsEmpModalOpen(false); setEditingEmp(null); }
        }
    }, 10);
  };

  const handleAutoGenerator = () => {
      const startDate = new Date(autoStartDate);
      const cycleDays = autoCycle === '1' ? 7 : 14;
      let newSchedule = [...schedule];
      const targetEmployees = autoTargetArea === 'æ‰€æœ‰åŒºåŸŸ' ? employees : employees.filter(e => e.area === autoTargetArea);
      if (targetEmployees.length === 0) { alert("è¯¥åŒºåŸŸæ²¡æœ‰äººå‘˜"); return; }
      if (autoType === 'night') {
          const areasToProcess = autoTargetArea === 'æ‰€æœ‰åŒºåŸŸ' ? configAreas : [autoTargetArea];
          areasToProcess.forEach(area => {
             const areaEmployees = targetEmployees.filter(e => e.area === area);
             if (areaEmployees.length === 0) return;
             areaEmployees.sort((a, b) => {
                 const countA = schedule.filter(s => s.employeeId === a.id && s.shift === ShiftType.NIGHT).length;
                 const countB = schedule.filter(s => s.employeeId === b.id && s.shift === ShiftType.NIGHT).length;
                 return countA - countB;
             });
             const targetEmp = areaEmployees[0];
             for(let i=0; i<cycleDays; i++) {
                 const d = new Date(startDate); d.setDate(startDate.getDate() + i);
                 const dateStr = d.toISOString().split('T')[0]; const dayOfWeek = d.getDay();
                 if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                     const existing = newSchedule.find(s => s.employeeId === targetEmp.id && s.date === dateStr);
                     if (existing && (existing.shift === ShiftType.LEAVE || existing.shift === ShiftType.TRIP)) continue;
                     newSchedule = newSchedule.filter(s => !(s.employeeId === targetEmp.id && s.date === dateStr));
                     newSchedule.push({ employeeId: targetEmp.id, date: dateStr, shift: ShiftType.NIGHT, location: targetEmp.area });
                 }
             }
          });
          alert(`å·²ä¸º ${autoTargetArea} å¤œç­è´Ÿè·æœ€å°‘çš„äººå‘˜åˆ†é…äº† ${autoCycle} å‘¨å¤œç­`);
      } else {
          for(let i=0; i<14; i++) {
              const d = new Date(startDate); d.setDate(startDate.getDate() + i); const dayOfWeek = d.getDay();
              if (dayOfWeek === 0 || dayOfWeek === 6) {
                  const dateStr = d.toISOString().split('T')[0];
                  const sortedEmps = [...targetEmployees].sort((a, b) => {
                      const countA = newSchedule.filter(s => s.employeeId === a.id && (new Date(s.date).getDay()===0 || new Date(s.date).getDay()===6) && s.shift!==ShiftType.OFF).length;
                      const countB = newSchedule.filter(s => s.employeeId === b.id && (new Date(s.date).getDay()===0 || new Date(s.date).getDay()===6) && s.shift!==ShiftType.OFF).length;
                      return countA - countB;
                  });
                  [0, 1].forEach(idx => {
                      if (sortedEmps[idx]) {
                          const existing = newSchedule.find(s => s.employeeId === sortedEmps[idx].id && s.date === dateStr);
                          if (existing && (existing.shift === ShiftType.LEAVE || existing.shift === ShiftType.TRIP)) return;
                          newSchedule = newSchedule.filter(s => !(s.employeeId === sortedEmps[idx].id && s.date === dateStr));
                          newSchedule.push({ employeeId: sortedEmps[idx].id, date: dateStr, shift: ShiftType.DAY, location: sortedEmps[idx].area });
                      }
                  });
              }
          }
          alert(`å·²ä¸º ${autoTargetArea} è‡ªåŠ¨åˆ†é…æœªæ¥ä¸¤å‘¨çš„å‘¨æœ«åŠ ç­`);
      }
      setSchedule(newSchedule); setIsAutoModalOpen(false);
  };

  const daysMap = { 0: 'å‘¨æ—¥', 1: 'å‘¨ä¸€', 2: 'å‘¨äºŒ', 3: 'å‘¨ä¸‰', 4: 'å‘¨å››', 5: 'å‘¨äº”', 6: 'å‘¨å…­' };

  return (
    <div id="dashboard-container" ref={dashboardRef} className="min-h-screen w-full text-skin-base font-sans selection:bg-cyan-200 selection:text-cyan-900 p-4 md:p-6 flex flex-col gap-6 bg-skin-fill transition-colors duration-300">
      
      <div className="flex flex-col gap-6 bg-skin-fill">
        
        {/* Header */}
        <header className="relative rounded-2xl bg-skin-card border border-skin-border p-6 shadow-md flex flex-col md:flex-row justify-between items-center gap-4 overflow-visible transition-colors duration-300">
           <div className="relative z-10">
             <h1 className="text-3xl font-bold text-skin-base tracking-tight flex items-center gap-3">
               <div className="p-2 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-lg text-white shadow-lg">
                 <CalendarDays className="w-6 h-6" />
               </div>
               å®éªŒå®¤äººå‘˜æ’ç­çŠ¶æ€çœ‹æ¿
             </h1>
             <p className="text-skin-muted text-sm mt-1 font-mono flex items-center gap-4">
               <span>ç³»ç»ŸçŠ¶æ€: åœ¨çº¿</span>
               <span className="w-px h-3 bg-skin-border"></span>
               <span>{new Date().toLocaleDateString('zh-CN')}</span>
               <span className="w-px h-3 bg-skin-border"></span>
               <span></span>
             </p>
           </div>
           
           <div className="relative z-10 flex items-center gap-3 flex-wrap justify-end">
             <div className="flex bg-skin-fill rounded-lg p-1 border border-skin-border">
                <button onClick={() => setCurrentTheme('light')} className={`p-2 rounded-md transition-all ${currentTheme === 'light' ? 'bg-skin-card text-emerald-600 shadow-sm' : 'text-skin-muted hover:text-skin-base'}`} title="æ¸…æ–°æµ…è‰²"><Sun className="w-4 h-4" /></button>
                <button onClick={() => setCurrentTheme('ocean')} className={`p-2 rounded-md transition-all ${currentTheme === 'ocean' ? 'bg-skin-card text-cyan-600 shadow-sm' : 'text-skin-muted hover:text-skin-base'}`} title="ç§‘æŠ€æ·±è“"><Droplets className="w-4 h-4" /></button>
                <button onClick={() => setCurrentTheme('dark')} className={`p-2 rounded-md transition-all ${currentTheme === 'dark' ? 'bg-skin-card text-blue-400 shadow-sm' : 'text-skin-muted hover:text-skin-base'}`} title="æå¤œæ·±è‰²"><Moon className="w-4 h-4" /></button>
             </div>
             <div className="w-px h-6 bg-skin-border mx-1"></div>
             <button onClick={() => setIsAutoModalOpen(true)} className="flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white rounded-lg transition-all shadow-md font-bold"><Sparkles className="w-5 h-5" /> æ™ºèƒ½æ’ç­</button>
             <button onClick={() => setIsConfigModalOpen(true)} className="flex items-center gap-2 px-4 py-2.5 text-skin-muted hover:text-skin-base hover:bg-skin-fill rounded-lg transition-all border border-transparent hover:border-skin-border"><Settings className="w-5 h-5" />å­—æ®µç®¡ç†</button>
             <button onClick={() => setIsStatsModalOpen(true)} className="flex items-center gap-2 px-4 py-2.5 text-skin-muted hover:text-skin-base hover:bg-skin-fill rounded-lg transition-all border border-transparent hover:border-skin-border"><BarChart3 className="w-5 h-5 text-emerald-500" />ç»Ÿè®¡</button>

             {/* ğŸŸ¢ å¯¼å‡º/å¯¼å…¥æŒ‰é’®åŒºåŸŸ */}
             <button onClick={handleExportJSON} className="flex items-center gap-2 px-4 py-2.5 text-skin-muted hover:text-skin-base hover:bg-skin-fill rounded-lg transition-all border border-transparent hover:border-skin-border" title="å¤‡ä»½æ•°æ®ä¸ºJSON"><FileJson className="w-5 h-5" />å¯¼å‡ºæ•°æ®</button>
             <button onClick={() => fileInputRef.current?.click()} className="flex items-center gap-2 px-4 py-2.5 text-skin-muted hover:text-skin-base hover:bg-skin-fill rounded-lg transition-all border border-transparent hover:border-skin-border" title="æ¢å¤JSONå¤‡ä»½æ•°æ®"><Upload className="w-5 h-5" />å¯¼å…¥æ•°æ®</button>
             <input ref={fileInputRef} type="file" accept=".json" className="hidden" onChange={handleImportJSON} />
             
             {/* ğŸŸ¢ æ–°å¢ï¼šå¤åˆ¶æœ¬å‘¨åˆ°ä¸‹ä¸€å‘¨æŒ‰é’® */}
             <button onClick={handleCopyWeekToNext} className="flex items-center gap-2 px-4 py-2.5 text-skin-muted hover:text-skin-base hover:bg-skin-fill rounded-lg transition-all border border-transparent hover:border-skin-border" title="å¤åˆ¶æœ¬å‘¨æ’ç­åˆ°ä¸‹ä¸€å‘¨">
                 <Copy className="w-5 h-5 text-orange-500" />
                 å¤åˆ¶æœ¬å‘¨
             </button>
             {/* ğŸŸ¢ ç»“æŸ */}

             <button onClick={handleResetData} className="p-2.5 text-skin-muted hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="é‡ç½®"><RotateCcw className="w-5 h-5" /></button>
             <button onClick={handleExportImage} disabled={isExporting} className="flex items-center gap-2 px-5 py-2.5 rounded-lg font-bold bg-skin-card hover:bg-skin-fill text-cyan-600 border border-cyan-200 transition-all shadow-sm">{isExporting ? <RefreshCw className="w-5 h-5 animate-spin" /> : <Download className="w-5 h-5" />}{isExporting ? 'ç”Ÿæˆä¸­...' : 'å›¾ç‰‡å¯¼å‡º'}</button>
             <button onClick={handleAnalyze} disabled={isAnalyzing} className={`flex items-center gap-2 px-5 py-2.5 rounded-lg font-bold transition-all duration-300 shadow-md ${isAnalyzing ? 'bg-blue-100 text-blue-400 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white'}`}>{isAnalyzing ? <RefreshCw className="w-5 h-5 animate-spin" /> : <Bot className="w-5 h-5" />} AIåˆ†æ</button>
           </div>
        </header>

        <main className="flex-1 rounded-2xl bg-skin-card border border-skin-border shadow-lg overflow-hidden flex flex-col transition-colors duration-300">
          {/* Visualization Header */}
          <div className="p-6 border-b border-skin-border bg-skin-fill flex flex-col gap-4 shrink-0 transition-colors duration-300">
              <h2 className="text-skin-base font-bold flex items-center gap-2"><div className="w-1 h-5 bg-cyan-500 rounded-full" />æœ¬å‘¨çŠ¶æ€</h2>
              <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
                <StatsCard title="æ€»äººæ•°" value={stats.totalScheduled} icon={<Users className="w-5 h-5 text-blue-500" />} color="blue" />
                <StatsCard title="æœ¬å‘¨ç™½ç­" value={stats.currentOnDuty} icon={<Sun className="w-5 h-5 text-emerald-500" />} color="emerald" />
                <StatsCard title="æœ¬å‘¨æ™šç­" value={stats.currentNightShift} icon={<Moon className="w-5 h-5 text-purple-500" />} color="purple" />
                <StatsCard title="å¤–å‹¤" value={stats.training} icon={<GraduationCap className="w-5 h-5 text-cyan-500" />} color="cyan" />
                <StatsCard title="æœ¬å‘¨è¯·å‡" value={stats.onLeave} icon={<AlertCircle className="w-5 h-5 text-red-500" />} color="red" />
                <StatsCard title="æœ¬å‘¨å‡ºå·®" value={stats.businessTrip} icon={<Plane className="w-5 h-5 text-amber-500" />} color="amber" />
              </div>
              <div className="mt-2 pt-4 border-t border-skin-border">
                  <h3 className="text-skin-base font-bold flex items-center gap-2 mb-3"><div className="w-1 h-5 bg-cyan-500 rounded-full" />åŒºåŸŸç»Ÿè®¡</h3>
                  <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-3">
                      {areaStats.map((stat, index) => {
                        const isRealArea = index < configAreas.length;
                        return (
                          <StatsCard 
                            key={`${stat.area}-${index}`} 
                            title={stat.area} 
                            value={stat.count} 
                            icon={<Users className="w-4 h-4 text-skin-muted" />} 
                            color={stat.isPlaceholder ? 'gray' : areaColors[index % areaColors.length]} 
                            draggable={isRealArea} 
                            onDragStart={(e) => isRealArea && handleDragStart(e, index)}
                            onDragOver={handleDragOver}
                            onDrop={(e) => isRealArea && handleDrop(e, index)}
                        />
                        );
                      })}
                  </div>
              </div>
          </div>

          {/* Toolbar */}
          <div className="border-b border-skin-border bg-skin-card shrink-0 transition-colors duration-300">
            {aiAnalysis && (
              <div className="m-4 rounded-xl bg-blue-50/50 border border-blue-200 p-4 relative animate-in fade-in slide-in-from-top-4 duration-500">
                <button 
                  onClick={() => setAiAnalysis(null)} 
                  className="absolute top-3 right-3 p-1 text-blue-400 hover:text-blue-600 hover:bg-blue-100 rounded-full transition-colors"
                >
                  <X className="w-5 h-5" />
                </button>
                <div className="flex items-start gap-4">
                  <div className="p-2 bg-blue-100 rounded-lg border border-blue-200">
                      <Bot className="w-6 h-6 text-blue-600" />
                  </div>
                  <div className="space-y-2 w-full">
                    <h3 className="font-bold text-blue-800">AI ä¼˜åŒ–å»ºè®®æŠ¥å‘Š</h3>
                    <p className="text-sm text-skin-base"><span className="font-semibold text-cyan-700">æ’ç­æ¦‚å†µ:</span> {aiAnalysis.summary}</p>
                    {aiAnalysis.issues && aiAnalysis.issues.length > 0 && (
                        <div className="text-sm text-red-700 mt-2">
                          <span className="font-semibold text-red-800">æ½œåœ¨é£é™©:</span>
                          <ul className="list-disc list-inside opacity-90">
                            {aiAnalysis.issues.map((iss, i) => <li key={i}>{iss}</li>)}
                          </ul>
                        </div>
                    )}
                    {aiAnalysis.recommendations && aiAnalysis.recommendations.length > 0 && (
                        <div className="text-sm text-emerald-700 mt-2">
                          <span className="font-semibold text-emerald-800">ä¼˜åŒ–å»ºè®®:</span>
                          <ul className="list-disc list-inside opacity-90">
                            {aiAnalysis.recommendations.map((rec, i) => <li key={i}>{rec}</li>)}
                          </ul>
                        </div>
                    )}
                  </div>
                </div>
              </div>
            )}
            <div className="p-5 flex flex-wrap gap-4 items-center justify-between">
                <div className="flex items-center gap-4 text-lg font-semibold text-skin-base">
                  <div className="flex items-center gap-2"><div className="w-1.5 h-6 bg-gradient-to-b from-cyan-400 to-blue-600 rounded-full" />æ’ç­è¯¦æƒ…</div>
                  <div className="flex items-center bg-skin-fill rounded-lg border border-skin-border p-1 gap-1">
                    <button onClick={() => handleWeekChange(-1)} className="p-1 hover:bg-skin-card rounded"><ChevronLeft className="w-4 h-4" /></button>
                    
                    <div className="relative group px-2 flex items-center gap-2 cursor-pointer rounded hover:bg-skin-card transition-all py-1">
                      <CalendarDays className="w-5 h-5 text-cyan-600" />
                      <span className="text-lg font-mono text-skin-base group-hover:text-cyan-600 transition-colors">
                        {dates[0].slice(5)} ~ {dates[6].slice(5)}
                      </span>
                      <Edit3 className="w-4 h-4 text-skin-muted opacity-0 group-hover:opacity-100 transition-opacity" />
                      <input 
                        type="date"
                        className="absolute inset-0 opacity-0 cursor-pointer z-20"
                        onChange={(e) => {
                          if (e.target.value) setCurrentDate(new Date(e.target.value));
                        }}
                      />
                    </div>

                    <button onClick={() => handleWeekChange(1)} className="p-1 hover:bg-skin-card rounded"><ChevronRight className="w-4 h-4" /></button>
                  </div>
                </div>
                <div className="flex flex-wrap items-center gap-3">
                  <div className="relative"><Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-skin-muted" /><input type="text" placeholder="æœç´¢..." className="pl-9 pr-4 py-1.5 bg-skin-card border border-skin-border rounded-lg text-sm w-32" value={filterName} onChange={(e) => setFilterName(e.target.value)} /></div>
                  
                  <div className="relative">
                    <Filter className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-skin-muted z-10 pointer-events-none" />
                    <button 
                      onClick={() => setIsAreaFilterOpen(!isAreaFilterOpen)}
                      className="pl-9 pr-8 py-1.5 bg-skin-card border border-skin-border rounded-lg text-sm cursor-pointer min-w-[120px] text-left flex items-center justify-between"
                    >
                      <span className="truncate max-w-[100px]">
                        {filterAreas.length === 0 ? "å…¨éƒ¨åŒºåŸŸ" : `å·²é€‰ ${filterAreas.length} é¡¹`}
                      </span>
                      <ChevronDown className="w-3 h-3 text-skin-muted" />
                    </button>
                    
                    {isAreaFilterOpen && (
                      <>
                        <div className="fixed inset-0 z-20" onClick={() => setIsAreaFilterOpen(false)} />
                        <div className="absolute top-full left-0 mt-1 w-56 bg-skin-card border border-skin-border rounded-lg shadow-xl z-30 max-h-64 overflow-y-auto py-1">
                           <div className="px-3 py-2 border-b border-skin-border flex justify-between items-center">
                             <span className="text-xs font-bold text-skin-muted">é€‰æ‹©æ˜¾ç¤ºåŒºåŸŸ</span>
                             <button onClick={() => setFilterAreas([])} className="text-xs text-blue-500 hover:underline">é‡ç½®</button>
                           </div>
                           {configAreas.map(area => {
                             const isSelected = filterAreas.includes(area);
                             return (
                               <div 
                                 key={area} 
                                 onClick={() => toggleAreaFilter(area)}
                                 className={`px-3 py-2 flex items-center gap-2 cursor-pointer hover:bg-skin-hover-fill text-sm ${isSelected ? 'text-blue-600 font-medium' : 'text-skin-base'}`}
                               >
                                 {isSelected ? <CheckSquare className="w-4 h-4 text-blue-600" /> : <Square className="w-4 h-4 text-skin-muted" />}
                                 {area}
                               </div>
                             );
                           })}
                        </div>
                      </>
                    )}
                  </div>
                  
                  <div className="relative">
                    <Clock className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-skin-muted" />
                    <select 
                      className="pl-9 pr-8 py-1.5 bg-skin-card border border-skin-border rounded-lg text-sm appearance-none cursor-pointer" 
                      value={filterShift} 
                      onChange={(e) => setFilterShift(e.target.value)}
                    >
                        <option value="å…¨éƒ¨">å…¨éƒ¨ç­æ¬¡</option>
                        <option value={ShiftType.DAY}>ç™½ç­</option>
                        <option value={ShiftType.NIGHT}>å¤œç­</option>
                        <option value={ShiftType.TRIP}>å‡ºå·®</option>
                        <option value={ShiftType.TRAINING}>åŸ¹è®­</option>
                        <option value={ShiftType.LEAVE}>è¯·å‡</option>
                    </select>
                  </div>

                  <div className="h-6 w-px bg-skin-border mx-1" />
                  <button onClick={handleAddEmployee} className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50/50 hover:bg-blue-100 text-blue-600 border border-blue-200/50 rounded-lg text-sm"><UserPlus className="w-4 h-4" />æ–°å¢</button>
                  <button onClick={() => setIsImportModalOpen(true)} className="flex items-center gap-1.5 px-3 py-1.5 bg-skin-card hover:bg-skin-fill text-skin-muted border border-skin-border rounded-lg text-sm"><Upload className="w-4 h-4" />å¯¼å…¥</button>
                </div>
            </div>
          </div>

          {/* Table */}
          <div className="flex-1 overflow-auto bg-skin-card relative min-h-[500px] transition-colors duration-300">
            <table className="w-full text-left border-collapse">
              <thead className="sticky top-0 z-20 shadow-sm transition-colors duration-300">
                <tr>
                  <th className="p-4 border-b border-r border-blue-600/20 font-bold w-48 min-w-[180px] text-center bg-blue-500 text-white text-lg">äººå‘˜ä¿¡æ¯</th>
                  {dates.map((date) => {
                    const d = new Date(date); const dayOfWeek = d.getDay(); const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    return (<th key={date} className={`p-4 border-b border-blue-600/20 font-medium min-w-[140px] text-center bg-blue-500`}><div className={`text-lg font-bold ${isWeekend ? 'text-orange-200' : 'text-white'}`}>{daysMap[dayOfWeek]}</div><div className={`text-lg mt-1 font-mono font-semibold ${isWeekend ? 'text-orange-200' : 'text-white'} opacity-90`}>{d.getMonth() + 1}/{d.getDate()}</div></th>);
                  })}
                </tr>
              </thead>
              <tbody>
                {filteredEmployees.length === 0 ? (<tr><td colSpan={8} className="p-12 text-center text-skin-muted">æœªæ‰¾åˆ°äººå‘˜</td></tr>) : (filteredEmployees.map(emp => (
                  <tr 
                    key={emp.id} 
                    draggable={!filterName && filterAreas.length === 0} 
                    onDragStart={(e) => handleRowDragStart(e, emp.id)}
                    onDragOver={handleRowDragOver}
                    onDrop={(e) => handleRowDrop(e, emp.id)}
                    className={`hover:bg-skin-hover-fill transition-colors group ${draggedRowId === emp.id ? 'opacity-40 bg-blue-50' : ''}`}
                    style={{ cursor: (!filterName && filterAreas.length === 0) ? 'move' : 'default' }}
                  >
                    <td className="p-3 border-b border-r border-skin-border bg-skin-fill">
                      <div className="flex items-center gap-2">
                        <div className={`text-skin-muted cursor-move hover:text-blue-500 ${(!filterName && filterAreas.length === 0) ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} title="æ‹–åŠ¨æ’åº (ç­›é€‰çŠ¶æ€ä¸‹ä¸å¯ç”¨)">
                           <GripVertical className="w-4 h-4" />
                        </div>
                        <div className="flex items-center gap-3 justify-center flex-1">
                          <div className="flex flex-col items-center">
                            <div className="font-bold text-lg text-skin-base flex items-center gap-2 cursor-pointer hover:text-blue-500" onClick={() => handleEditEmployee(emp)}>
                                {emp.name}
                                <Edit3 className="w-3 h-3 opacity-0 group-hover:opacity-50 text-skin-muted" />
                            </div>
                            <div className="mt-1 flex flex-col items-center gap-0.5">
                                <span className="text-xs font-extrabold text-blue-600 bg-blue-50/80 px-2 py-0.5 rounded border border-blue-200/50">
                                   {emp.area}
                                </span>
                                <span className="text-[11px] text-skin-muted pl-0.5">
                                   {emp.role}
                                </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>
                    {dates.map(date => {
                      const entry = getShiftFor(emp.id, date); const shift = entry ? entry.shift : ShiftType.DAY;
                      const hasBenches = entry?.benchIds && entry.benchIds.length > 0;
                      return (
                        <td key={date} className="p-2 border-b border-skin-border border-r border-skin-border/50 text-center relative">
                          <button 
                            onClick={() => handleCellClick(emp.id, date, shift, entry?.benchIds)} 
                            className={`w-full h-20 max-h-20 rounded-lg border flex flex-col items-center justify-center gap-0.5 transition-all relative group/cell overflow-hidden group ${SHIFT_COLORS[shift]} ${shift !== ShiftType.OFF ? '' : 'opacity-80'}`}
                          >
                            {(shift === ShiftType.DAY || shift === ShiftType.NIGHT) && hasBenches ? (
                              <div className="flex flex-col items-center w-full h-full py-1 px-1 overflow-hidden">
                                  <div className="h-4 flex items-center justify-center shrink-0 mb-0.5"><span className="font-bold text-xs leading-none text-black">{SHIFT_LABELS[shift]}</span></div>
                                  <div className={`flex-1 w-full overflow-hidden ${entry.benchIds.length <= 2 ? 'flex items-center justify-center gap-1' : 'grid grid-cols-3 gap-0.5 content-center'}`}>
                                     {entry.benchIds.slice(0, 9).map(b => (
                                       <div key={b} className={`flex items-center justify-center ${entry.benchIds.length === 1 ? 'px-3 py-1 text-xs' : (entry.benchIds.length === 2 ? 'w-[45%] py-0.5 text-[11px]' : 'w-full py-[1px] text-[10px]')} bg-white/90 rounded-[2px] border border-white/30 font-mono font-bold text-black truncate leading-tight`}>
                                            {b}
                                       </div>
                                     ))}
                                  </div>
                              </div>
                            ) : (<span className={`font-bold text-lg tracking-wide shrink-0 ${shift === ShiftType.OFF ? 'text-slate-500' : 'text-black'}`}>{SHIFT_LABELS[shift]}</span>)}
                            
                            <div className="absolute inset-0 bg-black/10 backdrop-blur-[1px] rounded-lg opacity-0 group-hover/cell:opacity-100 flex items-center justify-center transition-opacity pointer-events-none"><Edit3 className="w-5 h-5 text-white drop-shadow-md" /></div>
                            
                            {hasBenches && (
                                <div 
                                  className="absolute top-1 right-1 p-1 bg-white/20 hover:bg-white text-white hover:text-blue-600 rounded shadow-sm opacity-0 group-hover:opacity-100 transition-all z-10"
                                  onClick={(e) => handleCopyBenches(e, entry.benchIds)}
                                  title="å¤åˆ¶å°æ¶"
                                >
                                  <Copy className="w-3 h-3" />
                                </div>
                            )}

                            {benchClipboard && (
                                <div 
                                  className="absolute top-1 left-1 p-1 bg-white/20 hover:bg-white text-white hover:text-green-600 rounded shadow-sm opacity-0 group-hover:opacity-100 transition-all z-10"
                                  onClick={(e) => handlePasteBenches(e, emp.id, date)}
                                  title="ç²˜è´´å°æ¶"
                                >
                                  <ClipboardPaste className="w-3 h-3" />
                                </div>
                            )}
                          </button>
                        </td>
                      );
                    })}
                  </tr>
                )))}
              </tbody>
            </table>
          </div>
        </main>
      </div>

      {isConfigModalOpen && (
        <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
           <div className="bg-skin-card border border-skin-border rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col">
             <div className="p-5 border-b border-skin-border flex justify-between items-center bg-skin-fill"><h3 className="text-xl font-bold">å­—æ®µç®¡ç†</h3><button onClick={() => setIsConfigModalOpen(false)}><X className="w-6 h-6"/></button></div>
             <div className="overflow-y-auto p-6 space-y-8 bg-skin-card">
                <section className="space-y-3"><div className="font-bold text-cyan-600">åŒºåŸŸ</div><div className="flex gap-2"><input className="flex-1 border rounded px-3 py-2" value={newAreaInput} onChange={e=>setNewAreaInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleAddConfigItem('area',newAreaInput)}/><button onClick={()=>handleAddConfigItem('area',newAreaInput)} className="bg-cyan-600 text-white px-4 rounded">æ·»åŠ </button></div><div className="flex flex-wrap gap-2">{configAreas.map(i=><div key={i} className="border px-3 py-1 rounded flex items-center gap-2">{i}<button onClick={()=>handleDeleteConfigItem('area',i)}><X className="w-3 h-3"/></button></div>)}</div></section>
                <section className="space-y-3"><div className="font-bold text-purple-600">è§’è‰²</div><div className="flex gap-2"><input className="flex-1 border rounded px-3 py-2" value={newRoleInput} onChange={e=>setNewRoleInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleAddConfigItem('role',newRoleInput)}/><button onClick={()=>handleAddConfigItem('role',newRoleInput)} className="bg-purple-600 text-white px-4 rounded">æ·»åŠ </button></div><div className="flex flex-wrap gap-2">{configRoles.map(i=><div key={i} className="border px-3 py-1 rounded flex items-center gap-2">{i}<button onClick={()=>handleDeleteConfigItem('role',i)}><X className="w-3 h-3"/></button></div>)}</div></section>
                <section className="space-y-3"><div className="font-bold text-emerald-600">å°æ¶</div><div className="flex gap-2"><input className="flex-1 border rounded px-3 py-2" value={newBenchInput} onChange={e=>setNewBenchInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleAddConfigItem('bench',newBenchInput)}/><button onClick={()=>handleAddConfigItem('bench',newBenchInput)} className="bg-emerald-600 text-white px-4 rounded">æ·»åŠ </button></div><div className="flex flex-wrap gap-2">{configBenches.map(i=><div key={i} className="border px-3 py-1 rounded flex items-center gap-2">{i}<button onClick={()=>handleDeleteConfigItem('bench',i)}><X className="w-3 h-3"/></button></div>)}</div></section>
             </div>
           </div>
        </div>
      )}

      {isAutoModalOpen && (
         <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-md p-4 animate-in zoom-in-95 duration-200">
            <div className="bg-skin-card rounded-xl shadow-2xl border border-skin-border w-full max-w-md overflow-hidden">
               <div className="p-6 border-b border-skin-border bg-gradient-to-r from-purple-500/10 to-indigo-500/10">
                  <h3 className="text-xl font-bold text-skin-base flex items-center gap-2">
                     <Sparkles className="w-6 h-6 text-purple-500" />
                     æ™ºèƒ½è‡ªåŠ¨æ’ç­
                  </h3>
                  <p className="text-sm text-skin-muted mt-1">æ ¹æ®è§„åˆ™è‡ªåŠ¨ç”Ÿæˆæœªæ¥çš„æ’ç­è®¡åˆ’</p>
               </div>
               <div className="p-6 space-y-6">
                  <div className="space-y-2">
                     <label className="text-sm font-bold text-skin-base">1. é€‰æ‹©æ’ç­ç±»å‹</label>
                     <div className="grid grid-cols-2 gap-3">
                        <button onClick={()=>setAutoType('night')} className={`p-3 rounded-lg border flex flex-col items-center gap-2 transition-all ${autoType==='night'?'bg-purple-50 border-purple-500 text-purple-700':'hover:bg-skin-fill text-skin-muted'}`}><Moon className="w-6 h-6" /><span className="font-bold">æ™šç­è½®æ¢</span></button>
                        <button onClick={()=>setAutoType('weekend')} className={`p-3 rounded-lg border flex flex-col items-center gap-2 transition-all ${autoType==='weekend'?'bg-indigo-50 border-indigo-500 text-indigo-700':'hover:bg-skin-fill text-skin-muted'}`}><Sun className="w-6 h-6" /><span className="font-bold">å‘¨æœ«åŠ ç­</span></button>
                     </div>
                  </div>
                  <div className="space-y-2">
                     <label className="text-sm font-bold text-skin-base">2. é€‰æ‹©ç›®æ ‡åŒºåŸŸ</label>
                     <select value={autoTargetArea} onChange={(e)=>setAutoTargetArea(e.target.value)} className="w-full p-2 border rounded-lg bg-skin-fill"><option value="æ‰€æœ‰åŒºåŸŸ">æ‰€æœ‰åŒºåŸŸ (å…¨å±€è½®æ¢)</option>{configAreas.map(area => <option key={area} value={area}>{area}</option>)}</select>
                  </div>
                  {autoType === 'night' && (
                     <div className="space-y-2 animate-in slide-in-from-left-2">
                        <label className="text-sm font-bold text-skin-base">3. è½®æ¢å‘¨æœŸ</label>
                        <div className="flex gap-3"><button onClick={()=>setAutoCycle('1')} className={`flex-1 py-2 rounded border text-sm font-medium ${autoCycle==='1'?'bg-purple-600 text-white':'hover:bg-skin-fill'}`}>1å‘¨ä¸€æ¢</button><button onClick={()=>setAutoCycle('2')} className={`flex-1 py-2 rounded border text-sm font-medium ${autoCycle==='2'?'bg-purple-600 text-white':'hover:bg-skin-fill'}`}>2å‘¨ä¸€æ¢</button></div>
                     </div>
                  )}
                  <div className="space-y-2"><label className="text-sm font-bold text-skin-base">4. å¼€å§‹æ—¥æœŸ</label><input type="date" className="w-full p-2 border rounded-lg bg-skin-fill" value={autoStartDate} onChange={(e)=>setAutoStartDate(e.target.value)}/></div>
               </div>
               <div className="p-5 border-t border-skin-border bg-skin-fill flex justify-end gap-3"><button onClick={()=>setIsAutoModalOpen(false)} className="px-4 py-2 rounded text-skin-muted hover:text-skin-base">å–æ¶ˆ</button><button onClick={handleAutoGenerator} className="px-6 py-2 rounded bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold shadow-lg flex items-center gap-2"><Zap className="w-4 h-4" /> å¼€å§‹ç”Ÿæˆ</button></div>
            </div>
         </div>
      )}

      {isEditModalOpen && editingCell && (
        <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
          <div className="bg-skin-card border border-skin-border rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div className="p-5 border-b border-skin-border flex justify-between items-center bg-skin-fill"><h3 className="text-xl font-bold text-skin-base">è°ƒæ•´ç­æ¬¡</h3><button onClick={() => setIsEditModalOpen(false)}><X className="w-6 h-6" /></button></div>
            <div className="p-6 overflow-y-auto bg-skin-card">
              <div className="mb-6 grid grid-cols-3 gap-3">{Object.entries(SHIFT_LABELS).map(([key, label]) => (<button key={key} onClick={() => setTempShift(key)} className={`p-3 rounded-xl border ${tempShift === key ? 'bg-blue-600 border-[#FFC107] text-white' : 'bg-skin-card'}`}>{label}</button>))}</div>
              {(tempShift === ShiftType.DAY || tempShift === ShiftType.NIGHT) && (
                <div>
                  <div className="flex justify-between items-end mb-3"><div className="text-sm font-semibold">åˆ†é…å°æ¶</div>{!isAddingBench ? (<button onClick={() => setIsAddingBench(true)} className="text-xs text-blue-600 flex items-center"><Plus className="w-3 h-3" /> è‡ªå®šä¹‰</button>) : (<div className="flex items-center gap-2"><input autoFocus className="border rounded px-2 py-0.5 text-xs w-24" value={customBench} onChange={e => setCustomBench(e.target.value)} onKeyDown={e => {if(e.key==='Enter'&&customBench){toggleBenchSelection(customBench);setIsAddingBench(false);setCustomBench('')}}} /><button onClick={() => setIsAddingBench(false)}><X className="w-3 h-3"/></button></div>)}</div>
                  <div className="bg-skin-fill rounded-xl border p-4 max-h-60 overflow-y-auto flex flex-wrap gap-2">
                    {displayBenches.map(bench => (<button key={bench} onClick={() => toggleBenchSelection(bench)} className={`px-3 py-1.5 rounded-lg text-sm border flex items-center gap-2 ${tempBenchIds.includes(bench) ? 'bg-cyan-100 border-cyan-500 text-cyan-800' : 'bg-skin-card'}`}>{bench}{tempBenchIds.includes(bench) && <Check className="w-3 h-3" />}</button>))}
                  </div>
                </div>
              )}
            </div>
            <div className="p-5 border-t border-skin-border bg-skin-fill flex justify-end gap-3"><button onClick={() => setIsEditModalOpen(false)} className="px-5 py-2.5 rounded-lg text-skin-muted hover:bg-skin-hover-fill">å–æ¶ˆ</button><button onClick={handleSaveShift} className="px-6 py-2.5 rounded-lg bg-blue-600 text-white font-medium">ç¡®è®¤</button></div>
          </div>
        </div>
      )}

      {isEmpModalOpen && (
        <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
          <div className="bg-skin-card border border-skin-border rounded-2xl shadow-2xl w-full max-w-md">
            <div className="p-5 border-b border-skin-border flex justify-between items-center bg-skin-fill"><h3 className="text-xl font-bold text-skin-base">{editingEmp ? 'ç¼–è¾‘' : 'æ–°å¢'}äººå‘˜</h3><button onClick={() => setIsEmpModalOpen(false)}><X className="w-6 h-6" /></button></div>
            <div className="p-6 space-y-5 bg-skin-card">
              <div className="space-y-2"><label className="text-sm">å§“å</label><input className="w-full border rounded-lg p-3" value={tempEmpData.name||''} onChange={e => setTempEmpData(p => ({...p, name:e.target.value}))} /></div>
              <div className="space-y-2"><label className="text-sm">åŒºåŸŸ</label><select className="w-full border rounded-lg p-3" value={tempEmpData.area||''} onChange={e => setTempEmpData(p => ({...p, area:e.target.value}))}>{configAreas.map(a => <option key={a} value={a}>{a}</option>)}</select></div>
              <div className="space-y-2"><label className="text-sm">èŒçº§</label><select className="w-full border rounded-lg p-3" value={tempEmpData.role||''} onChange={e => setTempEmpData(p => ({...p, role:e.target.value}))}>{configRoles.map(r => <option key={r} value={r}>{r}</option>)}</select></div>
            </div>
            <div className="p-5 border-t border-skin-border bg-skin-fill flex justify-between items-center">
              {editingEmp ? <button onClick={(e) => executeDeleteEmployee(editingEmp.id, editingEmp.name, e)} className="text-red-600 flex items-center gap-2"><Trash2 className="w-4 h-4"/>åˆ é™¤</button> : <div/>}
              <div className="flex gap-3"><button onClick={() => setIsEmpModalOpen(false)} className="px-5 py-2.5 rounded-lg hover:bg-skin-hover-fill">å–æ¶ˆ</button><button onClick={handleSaveEmployee} className="px-6 py-2.5 rounded-lg bg-blue-600 text-white">ä¿å­˜</button></div>
            </div>
          </div>
        </div>
      )}

      {isImportModalOpen && (
        <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
          <div className="bg-skin-card border border-skin-border rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div className="p-5 border-b border-skin-border flex justify-between items-center bg-skin-fill">
              <h3 className="text-xl font-bold text-skin-base flex items-center gap-2"><Upload className="w-5 h-5 text-skin-muted" />å¯¼å…¥äººå‘˜</h3>
              <button onClick={() => setIsImportModalOpen(false)} className="text-skin-muted hover:text-skin-base transition-colors"><X className="w-6 h-6" /></button>
            </div>
            <div className="p-6 bg-skin-card space-y-4">
               <p className="text-sm text-skin-muted">è¯·è¾“å…¥äººå‘˜å§“åï¼Œæ”¯æŒæ‰¹é‡è¾“å…¥ã€‚å§“åä¹‹é—´å¯ç”¨é€—å·ã€ç©ºæ ¼æˆ–æ¢è¡Œåˆ†éš”ã€‚</p>
               <textarea className="w-full h-40 bg-skin-fill border border-skin-border rounded-lg p-3 text-skin-base focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none resize-none font-mono text-sm" placeholder={`å¼ ä¸‰\næå››\nç‹äº”`} value={importText} onChange={e => setImportText(e.target.value)} />
            </div>
            <div className="p-5 border-t border-skin-border bg-skin-fill flex justify-end gap-3"><button onClick={() => setIsImportModalOpen(false)} className="px-5 py-2.5 rounded-lg text-skin-muted hover:bg-skin-hover-fill transition-colors">å–æ¶ˆ</button><button onClick={handleBulkImport} disabled={!importText.trim()} className="px-6 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-medium shadow-lg shadow-blue-200 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">å¼€å§‹å¯¼å…¥</button></div>
          </div>
        </div>
      )}

      {isStatsModalOpen && (
         <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-md p-4">
            <div className="bg-skin-card border border-skin-border rounded-2xl shadow-2xl w-full max-w-[90vw] h-[90vh] flex flex-col overflow-hidden">
               <div className="p-6 border-b border-skin-border flex justify-between items-center bg-skin-card shrink-0">
                  <h3 className="text-xl font-extrabold">ç»Ÿè®¡æŠ¥è¡¨</h3>
                  <div className="flex gap-3"><button onClick={handleExportCSV} className="border px-4 py-2 rounded flex gap-2 hover:bg-skin-fill"><FileSpreadsheet className="w-4 h-4"/>å¯¼å‡ºExcel</button><button onClick={() => setIsStatsModalOpen(false)}><X className="w-6 h-6"/></button></div>
               </div>
               <div className="flex-1 overflow-hidden flex flex-col bg-skin-fill">
                  {statsSummary && (
                    <div className="p-6 grid grid-cols-1 md:grid-cols-4 gap-4 shrink-0">
                       <div className="bg-skin-card p-4 rounded border shadow-sm"><p className="text-sm text-muted">æ€»äººå¤©</p><p className="text-2xl font-bold">{statsSummary.totalManDays}</p></div>
                       <div className="bg-[#4CAF50]/10 p-4 rounded border border-[#4CAF50]/20"><p className="text-sm text-[#2E7D32]">ç™½ç­å æ¯”</p><p className="text-2xl font-bold text-[#2E7D32]">{statsSummary.dayRate}%</p></div>
                       <div className="bg-[#9C27B0]/10 p-4 rounded border border-[#9C27B0]/20"><p className="text-sm text-[#7B1FA2]">å¤œç­å æ¯”</p><p className="text-2xl font-bold text-[#7B1FA2]">{statsSummary.nightRate}%</p></div>
                       <div className="bg-[#F44336]/10 p-4 rounded border border-[#F44336]/20"><p className="text-sm text-[#C62828]">è¯·å‡ç‡</p><p className="text-2xl font-bold text-[#C62828]">{statsSummary.leaveRate}%</p></div>
                    </div>
                  )}
                  <div className="px-6 py-3 flex gap-4 border-y border-skin-border bg-skin-card shrink-0">
                      <div className="flex bg-skin-fill rounded p-1 border">{['month','quarter','year'].map(d=><button key={d} onClick={()=>setStatsDimension(d)} className={`px-3 py-1 rounded ${statsDimension===d?'bg-skin-card shadow':''}`}>{{month:'æœˆ',quarter:'å­£',year:'å¹´'}[d]}</button>)}</div>
                      <select value={statsYear} onChange={e=>setStatsYear(Number(e.target.value))} className="border rounded px-2">{Array.from({length:5},(_,i)=>new Date().getFullYear()-2+i).map(y=><option key={y} value={y}>{y}å¹´</option>)}</select>
                      {statsDimension==='month'&&<select value={statsMonth} onChange={e=>setStatsMonth(Number(e.target.value))} className="border rounded px-2">{Array.from({length:12},(_,i)=>i+1).map(m=><option key={m} value={m}>{m}æœˆ</option>)}</select>}
                  </div>
                  <div className="flex-1 overflow-hidden flex flex-col md:flex-row p-6 gap-6">
                      <div className="flex-[2] bg-skin-card rounded border shadow-sm overflow-hidden flex flex-col">
                         <div className="p-4 border-b font-bold">æ˜ç»†åˆ—è¡¨ <span className="text-xs font-normal text-muted">å…± {statisticsData.length} äºº</span></div>
                         <div className="flex-1 overflow-auto">
                            <table className="w-full text-left border-collapse text-sm">
                               <thead className="bg-skin-fill sticky top-0">
                                  <tr>{['å§“å','åŒºåŸŸ','ç™½ç­','å¤œç­','å‡ºå‹¤','å¤–å‹¤','è¯·å‡','å‘¨æœ«åŠ ç­','æ€»è®¡'].map(h=><th key={h} className="p-3 border-b">{h}</th>)}</tr>
                               </thead>
                               <tbody>
                                  {statisticsData.map(row=>(
                                    <tr key={row.id} className="hover:bg-blue-50/10">
                                       <td className="p-3 text-blue-500 cursor-pointer" onClick={()=>setSelectedPersonStats({emp:employees.find(e=>e.id===row.id),entries:row.entries})}>{row.name}</td>
                                       <td className="p-3 text-muted">{row.area}</td>
                                       <td className="p-3 font-bold text-[#4CAF50]">{row.dayShift}</td>
                                       <td className="p-3 font-bold text-[#9C27B0]">{row.nightShift}</td>
                                       <td className="p-3 font-bold text-[#FFC107]">{row.trip}</td>
                                       <td className="p-3 font-bold text-[#9C27B0]">{row.fieldWork}</td>
                                       <td className="p-3 font-bold text-[#F44336]">{row.leave}</td>
                                       <td className="p-3 font-bold text-orange-500">{row.weekendOvertime}</td>
                                       <td className="p-3 font-bold">{row.total}</td>
                                    </tr>
                                  ))}
                               </tbody>
                            </table>
                         </div>
                      </div>
                      <div className="flex-1 bg-skin-card rounded border p-4 flex flex-col">
                         <h4 className="font-bold mb-4">åˆ†å¸ƒå›¾</h4>
                         <div className="flex-1">
                            <ResponsiveContainer width="100%" height="100%">
                               <PieChart>
                                  <Pie data={statsSummary?.distribution||[]} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={80} label={({ name, value, percent }) => `${name} ${value} (${(percent * 100).toFixed(0)}%)`} labelLine={true} onClick={(d)=>setStatsSelectedChartSegment(d.type===statsSelectedChartSegment?null:d.type)} cursor="pointer">
                                     {statsSummary?.distribution.map((e,i)=><Cell key={i} fill={e.fill} opacity={statsSelectedChartSegment&&statsSelectedChartSegment!==e.type?0.3:1}/>)}
                                  </Pie>
                                  <RechartsTooltip/>
                               </PieChart>
                            </ResponsiveContainer>
                         </div>
                      </div>
                  </div>
               </div>
            </div>
         </div>
      )}

      {selectedPersonStats && (
        <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
           <div className="bg-skin-card rounded-xl shadow-2xl border w-full max-w-lg max-h-[700px] flex flex-col">
              <div className="p-4 border-b flex justify-between items-center bg-skin-fill">
                 <div><h3 className="font-bold text-lg">{selectedPersonStats.emp.name}</h3><p className="text-xs text-muted">æ’ç­æ˜ç»†</p></div>
                 <button onClick={()=>setSelectedPersonStats(null)}><X className="w-5 h-5"/></button>
              </div>
              <div className="flex-1 overflow-y-auto p-0">
                 <table className="w-full text-left text-sm">
                    <thead className="bg-skin-fill sticky top-0"><tr><th className="p-3 border-b">æ—¥æœŸ</th><th className="p-3 border-b">ç­æ¬¡</th><th className="p-3 border-b">å¤‡æ³¨</th></tr></thead>
                    <tbody>
                       {selectedPersonStats.entries.sort((a,b)=>a.date.localeCompare(b.date)).map((e,i)=>(
                         <tr key={i} className="hover:bg-skin-fill">
                            <td className="p-3 font-mono">{e.date}</td>
                            <td className="p-3"><span className="px-2 py-1 rounded text-xs text-white" style={{backgroundColor:STATS_COLORS[e.shift]}}>{SHIFT_LABELS[e.shift]}</span></td>
                            <td className="p-3 text-xs">{e.benchIds?.join(',')||e.location}</td>
                         </tr>
                       ))}
                    </tbody>
                 </table>
              </div>
           </div>
        </div>
      )}
    </div>
  );
};

export default App;